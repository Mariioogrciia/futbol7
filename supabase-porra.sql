CREATE TABLE public.predicciones ( id UUID PRIMARY KEY DEFAULT gen_random_uuid(), usuario_id UUID REFERENCES public.usuarios(id) NOT NULL, partido_id UUID REFERENCES public.partidos(id) NOT NULL, goles_local INTEGER NOT NULL, goles_visitante INTEGER NOT NULL, primer_goleador_id UUID REFERENCES public.jugadores(id), puntos INTEGER DEFAULT 0, created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(), updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(), UNIQUE(usuario_id, partido_id) ); -- Create a function to handle new user signups and give them 'espectador' role -- We wait for the trigger on auth.users CREATE OR REPLACE FUNCTION public.handle_new_user() RETURNS trigger AS \$\$ BEGIN INSERT INTO public.usuarios (id, email, nombre, rol, activo) VALUES (new.id, new.email, split_part(new.email, '@', 1), 'espectador', true); RETURN new; END; \$\$ LANGUAGE plpgsql SECURITY DEFINER; -- Trigger the function every time a user is created CREATE OR REPLACE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
