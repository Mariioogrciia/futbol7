{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/mario/PycharmProjects/futbol7/components/editable-avatar.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport Image from \"next/image\";\r\nimport { Camera, Loader2 } from \"lucide-react\";\r\nimport { supabase } from \"@/lib/supabase/client\";\r\nimport { toast } from \"sonner\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\ninterface EditableAvatarProps {\r\n    jugadorId: string;\r\n    currentFotoUrl: string | null;\r\n    jugadorNombre: string;\r\n}\r\n\r\nexport function EditableAvatar({ jugadorId, currentFotoUrl, jugadorNombre }: EditableAvatarProps) {\r\n    const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(jugadorNombre)}&background=0D8ABC&color=fff&size=200`;\r\n    const [avatarUrl, setAvatarUrl] = useState(currentFotoUrl || defaultAvatar);\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [canEdit, setCanEdit] = useState(false);\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const router = useRouter();\r\n\r\n    useEffect(() => {\r\n        setAvatarUrl(currentFotoUrl || defaultAvatar);\r\n    }, [currentFotoUrl, defaultAvatar]);\r\n\r\n    useEffect(() => {\r\n        // Check if the current user has permission to edit this avatar\r\n        // Rule: Admin OR if the user's email matches the player's info (we'll simplify to just admin for now or any logged in user as per request \"los jugadores autenticados\")\r\n        const checkAuth = async () => {\r\n            const { data: { session } } = await supabase.auth.getSession();\r\n            if (session) {\r\n                // For this request: \"Permitir a los jugadores autenticados subir y actualizar su foto\"\r\n                // Ideally we check if session.user.email == jugador.email but we don't have email in jugadores yet.\r\n                // Or if they are admin. We'll allow any authenticated user for now since it's a private app.\r\n                setCanEdit(true);\r\n            }\r\n        };\r\n        checkAuth();\r\n    }, []);\r\n\r\n    const uploadAvatar = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n        try {\r\n            setIsUploading(true);\r\n\r\n            if (!event.target.files || event.target.files.length === 0) {\r\n                throw new Error(\"Debes seleccionar una imagen para subir.\");\r\n            }\r\n\r\n            const file = event.target.files[0];\r\n            const fileExt = file.name.split('.').pop();\r\n            const filePath = `avatars/${jugadorId}-${Math.random()}.${fileExt}`;\r\n\r\n            // 1. Upload to Supabase Storage in 'galeria' bucket (or a new 'avatars' folder inside it)\r\n            const { error: uploadError, data } = await supabase.storage\r\n                .from('galeria')\r\n                .upload(filePath, file, { upsert: true });\r\n\r\n            if (uploadError) {\r\n                throw uploadError;\r\n            }\r\n\r\n            // 2. Get public URL\r\n            const { data: publicUrlData } = supabase.storage\r\n                .from('galeria')\r\n                .getPublicUrl(filePath);\r\n\r\n            const publicUrl = publicUrlData.publicUrl;\r\n\r\n            // 3. Update the 'jugadores' table via our new API endpoint (or direct client if RLS allows)\r\n            // It's safer to use an API endpoint to bypass RLS if needed, or if RLS allows users to update.\r\n            // Let's call an API route we will create next.\r\n            const response = await fetch('/api/players/avatar', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    jugador_id: jugadorId,\r\n                    foto_url: publicUrl,\r\n                }),\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const resData = await response.json();\r\n                throw new Error(resData.error || \"Error actualizando el perfil del jugador\");\r\n            }\r\n\r\n            setAvatarUrl(publicUrl);\r\n            toast.success(\"Foto de perfil actualizada correctamente\");\r\n            router.refresh(); // Tells Next.js to re-fetch Server Components\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Error uploading avatar:\", error);\r\n            toast.error(error.message || \"No se pudo subir la foto de perfil.\");\r\n        } finally {\r\n            setIsUploading(false);\r\n            if (fileInputRef.current) {\r\n                fileInputRef.current.value = \"\"; // Reset input\r\n            }\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative h-48 w-48 sm:h-64 sm:w-64 rounded-2xl overflow-hidden border-4 border-card shadow-xl ring-4 ring-accent/20 bg-muted group\">\r\n            <Image src={avatarUrl} alt={jugadorNombre} fill className=\"object-cover transition-transform duration-300 group-hover:scale-105\" />\r\n\r\n            {canEdit && (\r\n                <>\r\n                    <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center\">\r\n                        <button\r\n                            onClick={() => fileInputRef.current?.click()}\r\n                            disabled={isUploading}\r\n                            className=\"bg-accent/90 hover:bg-accent text-accent-foreground rounded-full p-4 shadow-lg transform transition-transform hover:scale-110 flex flex-col items-center justify-center\"\r\n                        >\r\n                            {isUploading ? <Loader2 className=\"h-8 w-8 animate-spin\" /> : <Camera className=\"h-8 w-8\" />}\r\n                            <span className=\"text-xs font-bold mt-1\">{isUploading ? 'Subiendo...' : 'Cambiar Foto'}</span>\r\n                        </button>\r\n                    </div>\r\n                    <input\r\n                        type=\"file\"\r\n                        ref={fileInputRef}\r\n                        accept=\"image/*\"\r\n                        className=\"hidden\"\r\n                        onChange={uploadAvatar}\r\n                        disabled={isUploading}\r\n                    />\r\n                </>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}